<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ page trimDirectiveWhitespaces="true"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title></title>

<script>
	/* 수정 */
	function goUpdate(fre_num) {
		document.free.action = "update";
		document.free.submit();
	}

	/* 삭제  */
	function goDelete(fre_num) {
		document.free.action = "delete?fre_num=" + fre_num;
		document.free.submit();
	}
</script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
<script>
$(document).ready(function() {
    var fre_num = $('#fre_num').val();
    var data ={'fre_num' : fre_num};
    
    $.ajax({
       url:'<%=request.getContextPath()%>/cmt/cmtList',
       contentType:'application/json',
       dataType:'json',
       data:JSON.stringify(data),
       type:'post',
       success : function(data){
    	  var loginUser = $('#loginUser').val();
          $.each(data, function(i) {
             var date = new Date(data[i].cmt_date);
        	 if(loginUser == data[i].mbr_id){
             var year = date.getFullYear();
             var month = (1 + date.getMonth());
             month = month >= 10 ? month : '0' + month;
             var day = date.getDate();
             day = day >= 10 ? day : '0' + day;
             var fullD = year + '년' + month + '월' + day + '일';
             var cmtList = '<div id="'
						+ data[i].cmt_num   
						+ '">작성자 : '
						+ data[i].mbr_id
						+ '  /  ' + '작성 날짜 : '
						+ fullD
						+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
						+'<a href="" id="'
						+data[i].cmt_num
						+'" '
						+'class="writeForm" name="writeForm" style="color:blue;">수정</a>'
						+'&nbsp;&nbsp;'
						+'<a href="" id="'
						+data[i].cmt_num
						+'" ' 
						+'class="delete" name="delete" style="color:red;">삭제</a>'
						+ '<div class="'
						+ data[i].cmt_num
						+ '" style="margin-bottom:5%; word-break:break-all;">'
						+ data[i].cmt_content
						+'</div></div>';
        	 } else {
        		 var date = new Date(data[i].cmt_date);
                 var year = date.getFullYear();
                 var month = (1 + date.getMonth());
                 month = month >= 10 ? month : '0' + month;
                 var day = date.getDate();
                 day = day >= 10 ? day : '0' + day;
                 var fullD = year + '년' + month + '월' + day + '일';
                 var cmtList = '<div id="'
    						+ data[i].cmt_num   
    						+ '">작성자 : '
    						+ data[i].admin_id
    						+ '  /  ' + '작성 날짜 : '
    						+ fullD
    						+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
    						+'&nbsp;&nbsp;'
    						+ '<div class="'
    						+ data[i].cmt_num
    						+ '" style="margin-bottom:5%; word-break:break-all;">'
    						+ data[i].cmt_content
    						+'</div></div>';
        	 }
             $('div#comment').append(cmtList);
          });          
       },
       error:function(error){
		   alert(error);   
       }
    });
});

/*  */
function commm_go() {
    var fre_num = $('#fre_num').val();
    var cmt_content = $('#cmt_content').val();
    var dataWrite = {
       'fre_num' : fre_num,
       'cmt_content' : cmt_content
    };
    $.ajax({
      url : '<%=request.getContextPath()%>/cmt/cmtWrite',
      data : JSON.stringify(dataWrite),
      type : 'post',
      contentType : 'application/json',
      success : function(data) {
    	 var loginUser = $('#loginUser').val();
         $('#cmt_content').val('');
         $('div #comment').empty();
         $.each(data, function(i) {
        	if(loginUser == data[i].mbr_id) {
            var date = new Date(data[i].cmt_date);
            var year = date.getFullYear();
            var month = (1 + date.getMonth());
            month = month >= 10 ? month : '0' + month;
            var day = date.getDate();
            day = day >= 10 ? day : '0' + day;
            var fullD = year + '년' + month + '월' + day + '일';
            var cmtList = '<div id="'
						+ data[i].cmt_num   
						+ '">작성자 : '
						+ data[i].mbr_id
						+ '  /  ' + '작성 날짜 : '
						+ fullD
						+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
						+'<a href="" id="'
						+data[i].cmt_num
						+'" '
						+'class="writeForm" name="writeForm" style="color:blue;">수정</a>'
						+'&nbsp;&nbsp;'
						+'<a href="" id="'
						+data[i].cmt_num
						+'" ' 
						+'class="delete" name="delete" style="color:red;">삭제</a>'
						+ '<div class="'
						+ data[i].cmt_num
						+ '" style="margin-bottom:5%; word-break:break-all;">'
						+ data[i].cmt_content
						+'</div></div>';
        	} else {
        		 var date = new Date(data[i].cmt_date);
                 var year = date.getFullYear();
                 var month = (1 + date.getMonth());
                 month = month >= 10 ? month : '0' + month;
                 var day = date.getDate();
                 day = day >= 10 ? day : '0' + day;
                 var fullD = year + '년' + month + '월' + day + '일';
                 var cmtList = '<div id="'
     						+ data[i].cmt_num   
     						+ '">작성자 : '
     						+ data[i].admin_id
     						+ '  /  ' + '작성 날짜 : '
     						+ fullD
     						+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     						+'&nbsp;&nbsp;'
     						+ '<div class="'
     						+ data[i].cmt_num
     						+ '" style="margin-bottom:5%; word-break:break-all;">'
     						+ data[i].cmt_content
     						+'</div></div>';
        	}
            $('div #comment').append(cmtList);
         });
      },
      error : function() {
         alert('댓글 등록 실패');
      }
   });
}

/* 자유게시판 댓글 삭제 */
$(document).on('click','.delete',function(e){
    e.preventDefault();
    var result = $(this).attr('id');
    $.ajax({
       		url:"<%=request.getContextPath()%>/cmt/cmtDelete",
			data : {
				"result" : result
			},
			dataType : 'json',
			type : 'post',
			success : function(cmtNum) {
		
				$('#' + cmtNum).remove();
			}
	});
});

/* 자유게시판 댓글 등록 */
$(document).on('click','.writeForm', function(e) {
	e.preventDefault();
    var result = $(this).attr('id');
    var aa = document.getElementsByClassName(result);
    $.ajax({
    	url : "<%=request.getContextPath()%>/cmt/cmtWriteForm",
    	data : {
    		"result" : result
    	},
    	dataType : 'json',
    	type : 'post',
    	success : function(map) {
			cmtList = jQuery.map(map, function(e){
				return e;
			});
			$('.'+cmtList).html(
				'<textarea id="mm" style="width : 467px;">'
				+ aa[0].innerHTML
				+'</textarea>'
				+'&nbsp;'
				+'<button type="button" id="'+result+'" class="btnn btn" '
	            + 'style="padding:8px; background-color: gray; border: 1px solid gray; font-size:14px; border-radius: 6px; color:white;">'
	            + '<i class="fa fa-exchange"></i>수정 </button>'
			);
    	}
    });
});

$(document).on('click','.btnn', function(e) {
	e.preventDefault();
	var result = $(this).attr('id');
	var tt = $('#mm').val();
	$.ajax({
		url : "<%=request.getContextPath()%>/cmt/cmtUpdate",
		data : {
			"result" : result,
			"tt" : tt
		},
		dataType : 'json',
		type : 'post',
		success : function(tt) {
			$('.' + cmtList).html(tt.cmt_content);
		}
	});

});
</script>

<style>
#freeView {
	margin: auto;
	width: 70%;
}

#mod, del, list {
	margin-left: 61.2%;
}

#cmt_content {
	width: 467px;
	height: 30px;
}
</style>
</head>
<body>
	<!-- PRELOADER -->
	<img id="preloader"
		src="<%=request.getContextPath()%>/resources/images/preloader.gif"
		alt="" />
	<!-- 로딩 이미지 -->

	<!-- //PRELOADER -->
	<div class="preloader_hide">
		<div class="qnaHeader">
        
			<!-- BREADCRUMBS -->
			<section class="breadcrumbs_block clearfix parallax">
				<div class="container center">
					<h2>
						<b>자유</b> 게시판
					</h2>
				</div>
			</section>
			<!-- //BREADCRUMBS -->
			<br>
			<form name="free" method="post" action="freeView">
				<div class="container">
					<table class="table" id="freeView">
						<tr>
							<th><i class="fa fa-folder-open-o"/>글번호</th>
							<td>${freeVO.fre_num }</td>
						</tr>
						
						<tr>
							<th><i class="fa fa-edit spaceLeft">제목</th>
							<td>${freeVO.fre_title }</td>
						</tr>

						<tr>
							<th><i class="fa fa-eye-slash"/>조회수</th>
							<td>${freeVO.fre_cnt }</td>
						</tr>
						
						<tr>
							<th><i class="fa fa-edit spaceLeft"/>내용</th>
							<td>${freeVO.fre_content }</td>
						</tr>

						<tr>
							<th><i class="fa fa-user"/>작성자</th>
							<td>${freeVO.mbr_id }</td>
						</tr>

						<tr>
							<th><i class="fa fa-clock-o"/>게시날짜</th>
							<td>${freeVO.fre_date }</td>
						</tr>

						<c:if test="${!empty freeVO.fre_pict_afat}">
						<tr>
						<th><i class="fa fa-image"/>사진첨부</th>
						<td>
						<img src="<%=request.getContextPath() %>/resources/upload/${freeVO.fre_pict_afat}" width="200px"> 
						
						<%-- <a href="<%=request.getContextPath()%>/cmmtphotoDownload/${cmmtVO.cmmt_num}">  
						<b style="color:#6495ed">파일다운로드</b></a>
						 --%>
						 
						 <a href="<%=request.getContextPath()%>/freephotoDownload/${freeVO.fre_num}">
						 <b style="color:#6495ed">파일 다운로드</b>
						 </a>
							
						</td>
					
						</tr>
						</c:if>

						<tr>
							<th><i class="fa fa-link"/>댓글</th>
							<td>
								<div id="comment"></div> 
								<input type="hidden"
								value="${freeVO.fre_num }" id="fre_num" name="fre_num">
								<textarea id="cmt_content" name="cmt_content"></textarea>
								<button type="button" id="insertCmt" class="btn"
									name="insertCmt" onclick="commm_go();"
									style="padding:8px; background-color: gray; border: 1px solid gray; 
									border-radius: 6px; color:white;">
									<i class="fa fa-sign-in"></i>&nbsp;<b style="font-size:14px">등록</b>
								</button>
							</td>
						</tr>
					</table>
				</div>
				<br>
				<c:choose>
					<c:when test="${freeVO.mbr_id==sessionScope.loginUser }">
						<!-- 수정  -->
						<button type="button" id="mod" class="btn"
							onclick="goUpdate('${freeVO.fre_num}')"
					 		style="padding:8px; background-color: gray; border: 1px solid gray; 
				 		 	border-radius: 6px; color:white;">
				  		<i class="fa fa-exchange"></i>&nbsp;<b style="font-size:14px">수정</b>
		    			</button>
						
						<!-- 삭제  -->
						<button type="button" id="del" class="btn"
							 onclick="goDelete('${freeVO.fre_num}')"
							 style="padding:8px; background-color: gray; border: 1px solid gray; 
							 border-radius: 6px; color:white;">
							 <i class="fa fa-cut"></i>&nbsp;<b style="font-size:14px">삭제</b>
					   </button>
						
						<!-- 목록 -->
						<button type="button" id="list" class="btn"
							onclick="location.href='freeList'"
							style="padding:8px; background-color: gray; border: 1px solid gray; 
							border-radius: 6px; color:white;">
							<i class="fa fa-list-ul"></i>&nbsp;<b style="font-size:14px">목록</b>
						</button>
						</c:when>

					<c:otherwise>
						<button type="button" id="list2" class="btn"
								onclick="location.href='freeList'"
							    style="padding:8px; background-color: gray; border: 1px solid gray; 
								border-radius: 6px; color:white; margin-left:68%;">
								<i class="fa fa-list-ul"></i>&nbsp;<b style="font-size:14px">목록</b>
						</button>

					</c:otherwise>
				</c:choose>

				<input type="hidden" value="${loginUser }" id="loginUser">
			</form>
		</div>
	</div>
	<br>

</body>
</html>
